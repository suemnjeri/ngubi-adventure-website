---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Main from "../../layouts/Main.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import LinkButton from "../../components/LinkButton.astro";

export async function getStaticPaths() {
  const allEvents = await getCollection("events", ({ data }) => {
    return data.draft !== true;
  });

  return allEvents.map((event) => ({
    params: { slug: event.slug },
    props: { event },
  }));
}

const { event } = Astro.props;
const { Content } = await event.render();

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(date);
}
---

<Layout title={`${event.data.title} - Ngubi Adventure Forest Camp`}>
  <Header />
  <Main class="bg-surface text-foreground">
    <div class="relative w-full h-[50vh] overflow-hidden">
      {event.data.eventImage && (
        <img
          src={event.data.eventImage}
          alt={event.data.title}
          class="w-full h-full object-cover"
        />
      )}
      <div class="absolute inset-0 bg-black opacity-40"></div>
      <div class="absolute inset-0 flex items-center justify-center p-4 text-center">
        <h1 class="text-4xl sm:text-5xl font-bold text-white leading-tight">
          {event.data.title}
        </h1>
      </div>
    </div>

    <article class="prose prose-lg dark:prose-invert max-w-app mx-auto px-4 py-12">
      <div class="mb-8 text-text-muted-dark">
        <p class="font-bold">
          {formatDate(event.data.eventDate)}
          {event.data.eventTime && ` at ${event.data.eventTime}`}
          {event.data.location && ` | ${event.data.location}`}
        </p>
      </div>

      <div class="prose">
        <Content />
      </div>

      <div class="text-center mt-12">
        <LinkButton
          href={event.data.registerLink || "/contact"}
          class="inline-block px-8 py-4 text-lg bg-accent text-white rounded-full font-semibold whitespace-nowrap hover:bg-accent-dark transition-colors duration-200 shadow-lg"
          ariaLabel={`Register for ${event.data.title}`}
          title={`Register for ${event.data.title}`}
        >
          {event.data.registerLink ? "Register Now" : "Contact Us"}
        </LinkButton>
      </div>
    </article>
  </Main>
  <Footer />
</Layout>


<!-- ---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import LinkButton from '../../components/LinkButton.astro'; // Assuming LinkButton is needed

import { marked } from 'marked'; // For manual Markdown parsing

// Function to get static paths for all events using Astro.glob()
export async function getStaticPaths() {
  const allEvents = await Astro.glob('src/data/events/**/*.md');
  const eventMarkdownFiles = allEvents.filter((file) => !file.frontmatter.draft); // ADDED THIS FILTER

  return eventMarkdownFiles.map(file => {
    const fileNameWithExtension = file.file.split('/').pop();
    const slug = fileNameWithExtension.replace(/\.md$/, '');

    const eventDateString = file.frontmatter.eventDate;
    const eventDateObject = new Date(eventDateString);

    return {
      params: { slug },
      props: {
        eventData: {
          slug: slug,
          data: {
            ...file.frontmatter,
            eventDate: eventDateObject,
          },
          body: file.rawContent(),
        }
      },
    };
  });
}

// Get the event data from props
const { eventData } = Astro.props;

// Manually parse the Markdown content (eventData.body) to HTML
const htmlContent = marked.parse(eventData.body);

// Helper function to format date for display on the page
function formatDate(date: Date): string {
  const d = date;

  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(d);
}
---

<Layout title={`${eventData.data.title} - Ngubi Adventure Forest Camp`}>
  <Header />
  <main class="pt-19 bg-surface text-foreground">

    {/* Event Header Section with Image */}


    <section class="relative w-full h-[400px] sm:h-[500px] bg-cover bg-center overflow-hidden mb-2" style={`background-image: url('${eventData.data.eventImage}');`}>
      <div class="absolute inset-0 bg-black opacity-10"></div>
      <div class="absolute inset-0 flex items-end px-8 pb-2 text-white">
        <div class="max-w-app mx-auto px-4 w-full">
          <h1 class="text-2xl sm:text-4xl font-bold">{eventData.data.title}</h1>
          <p class="text-sm sm:text-lg font-medium">
            {eventData.data.eventTime && `${formatDate(eventData.data.eventDate)} at ${eventData.data.eventTime}`}
            {!eventData.data.eventTime && formatDate(eventData.data.eventDate)}
            {eventData.data.location && ` | ${eventData.data.location}`}
          </p>
          {eventData.data.price && <p class="text-xl font-bold mt-4">{eventData.data.price}</p>}
        </div>
      </div>
    </section>

    

    {/* Event Content and Registration/RSVP Section */}
    <section class="max-w-app mx-auto px-4 py-2 text-text-muted">
      {/* Conditional rendering based on event price */}
      {eventData.data.price === 'Free Admission' ? (
        <> {/* Astro Fragment for Free Admission branch */}
          {/* === RSVP Form for Ngubi Friends & Family Day (Free Event) === */}
          {/* NEW: Render Markdown content first for free events */}
          <div class="prose max-w-none text-foreground mb-12" set:html={htmlContent}>
            {/* Markdown content will be injected here */}
          </div>

          <div class="bg-surface text-foreground p-8 rounded-lg shadow-lg border border-border">
              <h2 class="text-3xl font-bold mb-8 text-center text-accent">Confirm Your Attendance</h2>
              <p class="text-lg text-center max-w-2xl mx-auto mb-12 text-foreground">
                We're excited to have you join us for a special day of community and conservation! Please fill out the form below to confirm your attendance and help us prepare for all our guests.
              </p>

              <form name="community-day-rsvp-event-page" method="POST" data-netlify="true" data-netlify-honeypot="bot-field">
                <input type="hidden" name="form-name" value="community-day-rsvp-event-page" />
                <input type="hidden" name="event-title" value={eventData.data.title} />

                <div class="mb-5">
                  <label for="fullName" class="block text-foreground text-sm font-bold mb-2">Your Full Name:</label>
                  <input type="text" id="fullName" name="fullName" required class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>

                <div class="mb-5">
                  <label for="email" class="block text-foreground text-sm font-bold mb-2">Your Email:</label>
                  <input type="email" id="email" name="email" required class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>

                <div class="mb-5">
                  <label for="phone" class="block text-foreground text-sm font-bold mb-2">Phone Number (Optional):</label>
                  <input type="tel" id="phone" name="phone" class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>

                <div class="mb-5">
                  <label for="numAdults" class="block text-foreground text-sm font-bold mb-2">Number of Adults (13+):</label>
                  <input type="number" id="numAdults" name="numAdults" min="0" value="1" required class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>

                <div class="mb-5">
                  <label for="numChildren" class="block text-foreground text-sm font-bold mb-2">Number of Children (Under 13):</label>
                  <input type="number" id="numChildren" name="numChildren" min="0" value="0" class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border"></input>
                </div>

                <div class="mb-5">
                  <label for="message" class="block text-foreground text-sm font-bold mb-2">Any special requests or notes?</label>
                  <textarea id="message" name="message" rows="4" class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border"></textarea>
                </div>

                <div class="flex items-center justify-center">
                  <button type="submit" class="bg-accent hover:bg-accent-dark text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200">
                    Confirm My Attendance
                  </button>
                </div>
              </form>
          </div>
        </>
      ) : (
        <> {/* Astro Fragment for Paid/Other Events branch */}
          {/* Render the original Markdown content first */}
          <div class="prose max-w-none text-foreground mb-12" set:html={htmlContent}>
            {/* Markdown content will be injected here */}
          </div>

          {/* Then render the general registration form below the markdown */}
          <div class="bg-surface text-foreground p-8 rounded-lg shadow-lg border border-border">
            <h2 class="text-3xl font-bold mb-8 text-center text-accent">Register for {eventData.data.title}</h2>
            <p class="text-lg text-center max-w-2xl mx-auto mb-12 text-foreground">
              Ready to join us? Please fill out your details below to register for this event. You will be redirected to complete your payment upon submission.
            </p>

            <form name={`event-register-${eventData.slug}`} method="POST" data-netlify="true" data-netlify-honeypot="bot-field"
                  action={eventData.data.registerLink || '/contact'} action="/thank-you">
              <input type="hidden" name="form-name" value={`event-register-${eventData.slug}`} />
              <input type="hidden" name="event-title" value={eventData.data.title} />
              <input type="hidden" name="event-price" value={eventData.data.price} />
              <p class="hidden">
                <label>Don’t fill this out if you’re human: <input name="bot-field" /></label>
              </p>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5 max-w-xl mx-auto">
                <div>
                  <label for={`reg-fullName-${eventData.slug}`} class="block text-foreground text-sm font-bold mb-2">Full Name:</label>
                  <input type="text" id={`reg-fullName-${eventData.slug}`} name="fullName" required class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>
                <div>
                  <label for={`reg-email-${eventData.slug}`} class="block text-foreground text-sm font-bold mb-2">Email Address:</label>
                  <input type="email" id={`reg-email-${eventData.slug}`} name="email" required class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>
                <div>
                  <label for={`reg-phone-${eventData.slug}`} class="block text-foreground text-sm font-bold mb-2">Phone Number:</label>
                  <input type="tel" id={`reg-phone-${eventData.slug}`} name="phone" class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>
                <div>
                  <label for={`reg-groupSize-${eventData.slug}`} class="block text-foreground text-sm font-bold mb-2">Number of Participants:</label>
                  <input type="number" id={`reg-groupSize-${eventData.slug}`} name="numParticipants" min="1" value="1" required class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border" />
                </div>
              </div>
              <div class="max-w-xl mx-auto mb-5 mt-5">
                <label for={`reg-message-${eventData.slug}`} class="block text-foreground text-sm font-bold mb-2">Any special requests or notes?</label>
                <textarea id={`reg-message-${eventData.slug}`} name="message" rows="4" class="appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-white text-foreground dark:bg-gray-700 dark:text-white border-border"></textarea>
              </div>

              <div class="flex items-center justify-center mt-8">
                <button type="submit" class="bg-accent hover:bg-accent-dark text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline transition-colors duration-200">
                  Register & Pay Now
                </button>
              </div>
            </form>
          </div>
        </>
      )}
    </section>
    
    <Footer />
</Layout> -->